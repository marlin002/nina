<% content_for :title, "iAFS" %>

<div class="scrapes-header">
  <h1><%= link_to "iAFS", root_path, class: "home-link" %></h1>
  <p class="subtitle">
    <%= t('ui.tagline', article: ["en", "i", "din"].sample) %>
  </p>

  <div class="search-inline">
    <%= form_with url: search_scrapes_path, method: :get, local: true, class: "search-form" do %>
      <%= text_field_tag :q, @query, placeholder: t('search.form.placeholder'), class: "input-text" %>
      <%= submit_tag t('buttons.search'), class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<% if @query_error.present? %>
  <div class="empty-state">
    <h3>Felaktig sökfras</h3>
    <p><%= @query_error %></p>
  </div>
<% elsif @query.present? %>

  <div class="search-results">
    <% if @results.any? %>
      <table class="results-table">
        <thead>
          <tr>
            <th><%= t('headings.results') %>: <%= @results.length %> <%= t('nouns.hit', count: @results.length) %></th>
            <th class="sortable-header">
              <% if @sort_by == "reference_desc" %>
                <%= link_to t('search.table.regulation'), search_scrapes_path(q: @query, sort_by: "relevance"), class: "sort-header-link" %>
                <span class="sort-indicator">▼</span>
              <% elsif @sort_by == "reference" %>
                <%= link_to t('search.table.regulation'), search_scrapes_path(q: @query, sort_by: "reference_desc"), class: "sort-header-link" %>
                <span class="sort-indicator">▲</span>
              <% else %>
                <%= link_to t('search.table.regulation'), search_scrapes_path(q: @query, sort_by: "reference"), class: "sort-header-link" %>
              <% end %>
            </th>
          </tr>
        </thead>
        <tbody>
          <% @results.each do |res| %>
            <tr>
              <td class="match-snippet">
                <%# Display element text with highlighted query %>
                <p class="element-text"><%= highlight(res[:element_text], @query) %></p>
              </td>
              <td class="regulation-cell">
                <%# Display complete reference with hierarchy %>
                <div class="complete-reference">
                  <%= link_to res[:regulation_name], raw_scrape_path(res[:scrape], q: @query), class: "regulation-link", title: res[:subject] %>
                  <% if res[:complete_reference] != res[:regulation_name] %>
                    <br><span class="hierarchy-info"><%= res[:complete_reference].sub(res[:regulation_name], "").gsub(/^, /, "") %></span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">
        <h3><%= t('search.empty.no_results') %></h3>
        <p><%= t('search.empty.refine') %></p>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state">
    <h3><%= t('search.empty.start_search') %></h3>
    <p><%= t('search.empty.start_tip') %></p>
  </div>
<% end %>
