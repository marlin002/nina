<% content_for :title, "Nina - Search" %>

<div class="scrapes-header">
  <%= link_to "← Home", root_path, class: "back-link" %>
  <h1>🔎 Search Articles</h1>
  <p class="subtitle">Find matches in plain text across AFS 2023 regulations.</p>
</div>

<div class="search-bar">
  <%= form_with url: search_scrapes_path, method: :get, local: true, class: "search-form" do %>
    <div class="form-row">
      <div class="form-group">
        <label for="q">Search query</label>
        <%= text_field_tag :q, @query, placeholder: "Enter keywords (e.g., riskbedömning)", class: "input-text" %>
      </div>
      <div class="form-group small">
        <label for="context">Context</label>
        <%= number_field_tag :context, @context || 50, in: 10..200, step: 10, class: "input-number" %>
      </div>
      <div class="form-actions">
        <%= submit_tag "Search", class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>
  <p class="refine-hint">Tip: refine the search by adjusting the query or context and pressing Search again.</p>
</div>

<% if @query.present? %>
  <div class="search-summary">
    <p><strong>Query:</strong> <%= h(@query) %></p>
    <p><strong>Results:</strong> <%= @results.length %> match<%= 'es' unless @results.length == 1 %></p>
  </div>

  <div class="search-results">
    <% if @results.any? %>
      <table class="results-table">
        <thead>
          <tr>
            <th>Match</th>
            <th>Regulation</th>
          </tr>
        </thead>
        <tbody>
          <% @results.each do |res| %>
            <tr>
              <td class="match-snippet">
                <%# Highlight the matched text within the snippet %>
                <% highlighted = ''.html_safe %>
                <% highlighted << h(res[:leading]) %>
                <% highlighted << content_tag(:mark, h(res[:match])) %>
                <% highlighted << h(res[:trailing]) %>
                <p><%= highlighted %></p>
              </td>
              <td class="regulation-cell">
                <%= link_to res[:regulation], raw_scrape_path(res[:scrape]), class: "regulation-link", target: "_blank" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">
        <h3>No matches found</h3>
        <p>Try refining your search query or increasing the context.</p>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state">
    <h3>Start by searching</h3>
    <p>Enter a keyword or phrase to find matches across AFS 2023 Articles.</p>
  </div>
<% end %>
