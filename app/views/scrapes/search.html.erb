<% content_for :title, "Benina" %>

<div class="scrapes-header">
  <h1><%= link_to "Benina", root_path, class: "home-link" %></h1>
  <p class="subtitle">
    Sök enkelt i alla AFSar!
  </p>

  <div class="search-inline">
    <%= form_with url: search_scrapes_path, method: :get, local: true, class: "search-form" do %>
      <%= text_field_tag :q, @query, placeholder: "Sök paragrafer (ren text)", class: "input-text" %>
      <%= submit_tag "Sök", class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<% if @query.present? %>

  <div class="search-results">
    <% if @results.any? %>
      <table class="results-table">
        <thead>
          <% current_sort = params[:sort].presence || 'reg' %>
          <% current_dir = params[:dir].presence || 'asc' %>
          <% next_dir_reg = (current_sort == 'reg' && current_dir == 'asc') ? 'desc' : 'asc' %>
          <% next_dir_text = (current_sort == 'text' && current_dir == 'asc') ? 'desc' : 'asc' %>
          <tr>
            <th>
              <%= link_to search_scrapes_path(q: @query, sort: 'text', dir: next_dir_text), class: "sort-link" do %>
                Resultat <%= current_sort == 'text' ? (current_dir == 'asc' ? '↑' : '↓') : '' %>
              <% end %>
              : <%= @results.length %> träff<%= @results.length == 1 ? '' : 'ar' %>
            </th>
            <th>
              <%= link_to search_scrapes_path(q: @query, sort: 'reg', dir: next_dir_reg), class: "sort-link" do %>
                Föreskrift <%= current_sort == 'reg' ? (current_dir == 'asc' ? '↑' : '↓') : '' %>
              <% end %>
            </th>
          </tr>
        </thead>
        <tbody>
          <% @results.each do |res| %>
            <tr>
              <td class="match-snippet">
                <p><%= highlight_matches(collapse_whitespace(res[:element_text]), @query) %></p>
              </td>
              <td class="regulation-cell">
                <%= link_to(res[:display_label].presence || res[:regulation], raw_scrape_path(res[:scrape], q: @query, anchor: res[:element_id]), class: "regulation-link", target: "_blank") %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">
        <h3>Inga träffar</h3>
        <p>Försök förfina sökfrågan.</p>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state">
    <h3>Börja med att söka</h3>
    <p>Ange ett sökord eller en fras för att hitta träffar i AFS 2023 paragrafer.</p>
  </div>
<% end %>
